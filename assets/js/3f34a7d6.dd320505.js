"use strict";(self.webpackChunkwjftu_ds=self.webpackChunkwjftu_ds||[]).push([[9123],{8267:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>i,contentTitle:()=>s,default:()=>l,frontMatter:()=>c,metadata:()=>n,toc:()=>u});const n=JSON.parse('{"id":"springboot/data/dynamic-datasource","title":"\u52a8\u6001\u914d\u7f6e\u591a\u6570\u636e\u6e90","description":"AbstractRoutingDataSource \u53ef\u4ee5\u5e2e\u6211\u4eec\u5b9e\u73b0\u52a8\u6001\u914d\u7f6e\u591a\u6570\u636e\u6e90\uff0c\u5e76\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u6dfb\u52a0\u548c\u5220\u9664\u6570\u636e\u6e90","source":"@site/note/springboot/data/dynamic-datasource.md","sourceDirName":"springboot/data","slug":"/springboot/data/dynamic-datasource","permalink":"/note/springboot/data/dynamic-datasource","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"\u52a8\u6001\u914d\u7f6e\u591a\u6570\u636e\u6e90","sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"JDBC","permalink":"/note/springboot/data/jdbc"},"next":{"title":"MyBatis","permalink":"/note/springboot/data/mybatis"}}');var r=t(4848),o=t(8453);const c={title:"\u52a8\u6001\u914d\u7f6e\u591a\u6570\u636e\u6e90",sidebar_position:2},s=void 0,i={},u=[];function d(e){const a={code:"code",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(a.p,{children:"AbstractRoutingDataSource \u53ef\u4ee5\u5e2e\u6211\u4eec\u5b9e\u73b0\u52a8\u6001\u914d\u7f6e\u591a\u6570\u636e\u6e90\uff0c\u5e76\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u6dfb\u52a0\u548c\u5220\u9664\u6570\u636e\u6e90"}),"\n",(0,r.jsx)(a.p,{children:"\u5b9a\u4e49\u4e00\u4e2a\u7c7b\uff0c\u7ee7\u627f AbstractRoutingDataSource \uff0c\u5b9e\u73b0 determineCurrentLookupKey \u65b9\u6cd5\uff0c determineCurrentLookupKey \u65b9\u6cd5\u7528\u4e8e\u5728\u8fd0\u884c\u65f6\u627e\u5230\u6570\u636e\u6e90\u7684 key \uff0c\u7136\u540e\u6839\u636e key \u627e\u5230\u9700\u8981\u4f7f\u7528\u7684\u6570\u636e\u6e90\u3002\u521b\u5efa\u4e00\u4e2a addDataSource \u65b9\u6cd5\uff0c\u7528\u4e8e\u5728\u8fd0\u884c\u65f6\u6dfb\u52a0\u6570\u636e\u6e90\uff0c\u4f20\u5165\u9a71\u52a8\u540d\u79f0\uff0cjdbc url\uff0c\u7528\u6237\u540d\uff0c\u5bc6\u7801\uff0c\u53cd\u5c04\u5f97\u5230\u9a71\u52a8\u7c7b\uff0c\u6784\u9020\u4e00\u4e2a\u7b80\u5355\u7684 SimpleDriverDataSource \u6570\u636e\u6e90\u3002 setTargetDataSources \u7528\u4e8e\u8bbe\u7f6e\u6570\u636e\u6e90\uff0c\u4f20\u5165\u4e00\u4e2a map \uff0cmap \u7684 key \u662f determineCurrentLookupKey \u8fd4\u56de\u7684 key \uff0c\u8fd9\u91cc\u5b9a\u4e49 jdbc url \u4e3a\u6570\u636e\u6e90\u7684 key\u3002 afterPropertiesSet \u65b9\u6cd5\u5728 setTargetDataSources \u540e\u8c03\u7528\uff0c\u8ba9\u914d\u7f6e\u751f\u6548\u3002"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-java",children:"public class DynamicDataSource extends AbstractRoutingDataSource {\n    @Override\n    protected Object determineCurrentLookupKey() {\n        return DataSourceKeyHolder.getKey();\n    }\n\n    public void addDataSource(String driverClassName, String url, String username, String password) {\n        try {\n            Class<?> clazz = Class.forName(driverClassName);\n            Driver driver = (Driver) clazz.newInstance();\n            DataSource dataSource = new SimpleDriverDataSource(driver, url, username, password);\n            Map<Object,Object> targetDataSources = new HashMap<>();\n            targetDataSources.put(url, dataSource);\n            setTargetDataSources(targetDataSources);\n            afterPropertiesSet();\n        } catch (ClassNotFoundException e) {\n            throw new RuntimeException(e);\n        } catch (InstantiationException e) {\n            throw new RuntimeException(e);\n        } catch (IllegalAccessException e) {\n            throw new RuntimeException(e);\n        }\n    }\n\n}\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u4ece AbstractRoutingDataSource \u7684\u6e90\u7801\u53ef\u4ee5\u770b\u5230\uff0csetTargetDataSources \u53ea\u662f\u628a map \u4f20\u5165\uff0c\u8c03\u7528 afterPropertiesSet \u65b9\u6cd5\u624d\u4f1a\u91cd\u65b0\u8bbe\u7f6e resolvedDataSources \u8ba9\u914d\u7f6e\u7684\u6570\u636e\u6e90 map \u751f\u6548\u3002setTargetDataSources \u9700\u8981\u5168\u91cf\u914d\u7f6e\uff0c\u5426\u5219\u4e4b\u524d\u7684\u914d\u7f6e\u4f1a\u6d88\u5931\u3002"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-java",children:"public void setTargetDataSources(Map<Object, Object> targetDataSources) {\n    this.targetDataSources = targetDataSources;\n}\n\npublic void afterPropertiesSet() {\n    if (this.targetDataSources == null) {\n        throw new IllegalArgumentException(\"Property 'targetDataSources' is required\");\n    } else {\n        this.resolvedDataSources = CollectionUtils.newHashMap(this.targetDataSources.size());\n        this.targetDataSources.forEach((key, value) -> {\n            Object lookupKey = this.resolveSpecifiedLookupKey(key);\n            DataSource dataSource = this.resolveSpecifiedDataSource(value);\n            this.resolvedDataSources.put(lookupKey, dataSource);\n        });\n        if (this.defaultTargetDataSource != null) {\n            this.resolvedDefaultDataSource = this.resolveSpecifiedDataSource(this.defaultTargetDataSource);\n        }\n\n    }\n}\n"})}),"\n",(0,r.jsx)(a.p,{children:"DataSourceKeyHolder \u901a\u8fc7 ThreadLocal \u6765\u914d\u7f6e\u5f53\u524d\u7ebf\u7a0b\u4f7f\u7528\u7684\u6570\u636e\u6e90\u540d\u5b57\u3002"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-java",children:"public class DataSourceKeyHolder {\n\n    private static ThreadLocal<String> threadLocal = new ThreadLocal<>();\n\n    public static String getKey() {\n        return threadLocal.get();\n    }\n\n    public static void setKey(String key) {\n        threadLocal.set(key);\n    }\n\n}\n"})}),"\n",(0,r.jsx)(a.p,{children:"\u6570\u636e\u6e90\u914d\u7f6e\u7c7b\uff0cdataSource \u521b\u5efa\u4e00\u4e2a\u666e\u901a\u6570\u636e\u6e90\u4f5c\u4e3a\u9ed8\u8ba4\u6570\u636e\u6e90\uff0c\u518d\u521b\u5efa\u4e00\u4e2a DynamicDataSource \u7684 bean \uff0c\u7528\u4e8e\u52a8\u6001\u65b0\u589e\u548c\u7ba1\u7406\u6570\u636e\u6e90\uff0c\u8bbe\u7f6e defaultDataSource \u4e3a\u9ed8\u8ba4\u6570\u636e\u6e90\u3002\u5f53 determineCurrentLookupKey \u65b9\u6cd5\u8fd4\u56de\u7a7a\u6216\u8fd4\u56de\u7684\u6570\u636e\u6e90\u4e0d\u5b58\u5728\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u7684\u3002"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-java",children:'@Configuration\npublic class DataSourceConfig {\n\n    @Bean(name = "defaultDataSource")\n    @ConfigurationProperties(prefix = "spring.datasource")\n    DataSource dataSource() {\n        DataSource dataSource = DataSourceBuilder.create()\n                .build();\n        return dataSource;\n    }\n\n    @Bean(name = "dataSource")\n    @Primary\n    DataSource dynamicDataSource(\n            @Qualifier("defaultDataSource")\n            DataSource defaultDataSource\n    ) {\n        DynamicDataSource dynamicDataSource = new DynamicDataSource();\n        dynamicDataSource.setDefaultTargetDataSource(defaultDataSource);\n        dynamicDataSource.setTargetDataSources(new HashMap<>());\n\n        return dynamicDataSource;\n    }\n\n\n}\n\n'})}),"\n",(0,r.jsx)(a.p,{children:"\u6d4b\u8bd5\u7c7b\uff0c\u4f7f\u7528 mybatis \u8fdb\u884c\u6d4b\u8bd5"}),"\n",(0,r.jsx)(a.p,{children:"\u7b2c\u4e00\u6b21\u8fd0\u884c\uff0c\u8fd4\u56de\u7684\u662f\u9ed8\u8ba4\u6570\u636e\u6e90\u7684\u7ed3\u679c\u3002\u7136\u540e\u52a8\u6001\u6dfb\u52a0\u6570\u636e\u6e90\uff0c\u7b2c\u4e8c\u6b21\u8fd0\u884c\uff0c\u8fd8\u662f\u9ed8\u8ba4\u6570\u636e\u6e90\u7684\u7ed3\u679c\uff0c\u56e0\u4e3a\u6ca1\u6709\u5728 DataSourceKeyHolder \u4e2d\u8bbe\u7f6e\u5f53\u524d\u7ebf\u7a0b\u6570\u636e\u6e90\u3002\u5728 DataSourceKeyHolder \u8bbe\u7f6e\u5f53\u524d\u7ebf\u7a0b\u6570\u636e\u6e90\u540e\uff0c\u7b2c\u4e09\u6b21\u8fd0\u884c\uff0c\u8fd4\u56de\u65b0\u589e\u6570\u636e\u6e90\u7684\u7ed3\u679c\u3002"}),"\n",(0,r.jsx)(a.pre,{children:(0,r.jsx)(a.code,{className:"language-java",children:'@SpringBootTest\npublic class TestMapper {\n\n    @Autowired\n    StudentMapper studentMapper;\n\n    @Autowired\n    DynamicDataSource dynamicDataSourced;\n\n    @Test\n    public void testAddDataSourceAtRuntime() {\n\n        ArrayList<Student> list = studentMapper.findAll();\n\n        String url = "jdbc:mysql://a.com:3307/mydb";\n        String driverClassName = "com.mysql.cj.jdbc.Driver";\n        String username = "aaa";\n        String password = "16fccf4470fd";\n\n        dynamicDataSourced.addDataSource(driverClassName, url, username, password);\n\n        list = studentMapper.findAll();\n        System.out.println(list);\n        DataSourceKeyHolder.setKey(url);\n\n        list = studentMapper.findAll();\n        System.out.println(list);\n\n    }\n}\n'})})]})}function l(e={}){const{wrapper:a}={...(0,o.R)(),...e.components};return a?(0,r.jsx)(a,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,a,t)=>{t.d(a,{R:()=>c,x:()=>s});var n=t(6540);const r={},o=n.createContext(r);function c(e){const a=n.useContext(o);return n.useMemo(function(){return"function"==typeof e?e(a):{...a,...e}},[a,e])}function s(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),n.createElement(o.Provider,{value:a},e.children)}}}]);