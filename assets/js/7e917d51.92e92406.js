"use strict";(self.webpackChunkwjftu_ds=self.webpackChunkwjftu_ds||[]).push([[9974],{4952:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"springboot/web/security","title":"Spring Boot Security","description":"\u4f7f\u7528 Spring Boot Security \u4fdd\u62a4 web \u5e94\u7528","source":"@site/note/springboot/web/security.md","sourceDirName":"springboot/web","slug":"/springboot/web/security","permalink":"/note/springboot/web/security","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u5168\u5c40\u5f02\u5e38\u5904\u7406","permalink":"/note/springboot/web/handle-exception"},"next":{"title":"Springdoc","permalink":"/note/springboot/web/springdoc"}}');var t=r(4848),i=r(8453);const o={},a="Spring Boot Security",l={},c=[];function u(e){const n={br:"br",code:"code",h1:"h1",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"spring-boot-security",children:"Spring Boot Security"})}),"\n",(0,t.jsx)(n.p,{children:"\u4f7f\u7528 Spring Boot Security \u4fdd\u62a4 web \u5e94\u7528"}),"\n",(0,t.jsx)(n.p,{children:"\u521b\u5efa web \u9879\u76ee\uff0c\u5e76\u5f15\u5165 security \u4f9d\u8d56\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"dependencies {\n    implementation 'org.springframework.boot:spring-boot-starter-security'\n    implementation 'org.springframework.boot:spring-boot-starter-web'\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u5b9a\u4e49\u4e00\u4e2a controller \u7528\u4e8e\u6d4b\u8bd5"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'@RequestMapping("/hello")\n@ResponseBody\npublic String hello() {\n    return "hello";\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u542f\u52a8\u9879\u76ee\uff0c\u7531\u4e8e\u81ea\u52a8\u914d\u7f6e\uff0c\u65e5\u5fd7\u4f1a\u6253\u5370\u5bc6\u7801\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Using generated security password: 645debf5-5eff-4941-a1eb-a5122c48258b\n\nThis generated password is for development use only. Your security configuration must be updated before running your application in production.\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u6d4f\u89c8\u5668\u8bbf\u95ee\u4efb\u4f55 url \u4f1a\u8df3\u8f6c\u5230\u767b\u9646\u9875\u9762\uff0c\u767b\u9646\u6210\u529f\u4f1a\u5728 response header \u91cc\u9762 set cookie \uff0c\u540e\u7eed\u8bf7\u6c42\u5e26\u4e0a JSESSIONID \u5373\u53ef\u8bbf\u95ee"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"set-cookie:\nJSESSIONID=359740A39A193A7E36CE4330444BBD5B; Path=/; HttpOnly\n\ncurl 'http://localhost:8080/hello' -b 'JSESSIONID=359740A39A193A7E36CE4330444BBD5B'\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 http basic \u8ba4\u8bc1"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"curl -u user:645debf5-5eff-4941-a1eb-a5122c48258b http://localhost:8080/hello\n"})}),"\n",(0,t.jsx)(n.p,{children:"SecurityFilterChain \u7528\u4e8e\u914d\u7f6e Security \u7684\u6838\u5fc3\u63a5\u53e3\uff0c\u914d\u7f6e\u54ea\u4e9b\u8bf7\u6c42\u9700\u8981\u8ba4\u8bc1\uff0c\u5982\u4f55\u5904\u7406\u8ba4\u8bc1\u548c\u6388\u6743\uff0c\u7b49\u7b49"}),"\n",(0,t.jsxs)(n.p,{children:["UserDetailsService \u7528\u4e8e\u7ba1\u7406 user",(0,t.jsx)(n.br,{}),"\n","PasswordEncode \u7528\u4e8e\u52a0\u5bc6\u5bc6\u7801"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class SecurityConfig {\n\n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        http\n            .authorizeHttpRequests(auth -> auth\n                .anyRequest().authenticated()\n            )\n            .formLogin(withDefaults());\n\n        return http.build();\n    }\n\n    @Bean\n    public UserDetailsService userDetailsService() {\n        UserDetails user = User\n                .withUsername("user")\n                .password(passwordEncoder().encode("password"))\n                .roles("USER")\n                .build();\n\n        return new InMemoryUserDetailsManager(user);\n    }\n\n    @Bean\n    public PasswordEncoder passwordEncoder() {\n        return new BCryptPasswordEncoder();\n    }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u4f7f\u7528 h2 \u548c jpa \u5b58\u50a8\u7528\u6237\u4fe1\u606f"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yml",children:"spring:\n  datasource:\n    url: jdbc:h2:mem:testdb\n    driver-class-name: org.h2.Driver\n    username: sa\n    password: ''\n  h2:\n    console:\n      enabled: true\n      path: /h2-console\n  jpa:\n    hibernate:\n      ddl-auto: update\n    show-sql: true\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u81ea\u5b9a\u4e49 User \u548c UserDetailService"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public class MyUser {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    Long id;\n\n    @Column(name = "username", nullable = false, unique = true)\n    String username;\n\n    @Column(name = "password", nullable = false)\n    String password;\n\n\n    @ElementCollection(fetch = FetchType.EAGER)\n    @CollectionTable(name = "user_roles", joinColumns = @JoinColumn(name = "user_id"))\n    @Column(name = "role")\n    private Set<String> roles;\n    \n}\n\n\n@Service\n@AllArgsConstructor\npublic class MyUserDetailService implements UserDetailsService {\n\n    private MyUserRepository myUserRepository;\n\n    private PasswordEncoder passwordEncoder;\n    \n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n        MyUser user = myUserRepository.findByUsername(username)\n                .orElseThrow(() -> new UsernameNotFoundException("User not found"));\n\n        List<GrantedAuthority> authorities = user.getRoles().stream()\n            .map(role -> (GrantedAuthority) new SimpleGrantedAuthority(role))\n            .toList();\n        return new User(user.getUsername(), user.getPassword(), authorities);\n    }\n\n    public void addUser(MyUser user) {\n        user.setPassword(passwordEncoder.encode(user.getPassword()));\n        myUserRepository.save(user);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u542f\u52a8\u4f1a\u81ea\u52a8\u521b\u5efa\u8868"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Hibernate: create table my_user (id bigint generated by default as identity, password varchar(255) not null, username varchar(255) not null, primary key (id))\nHibernate: create table user_roles (user_id bigint not null, role varchar(255))\nHibernate: alter table if exists my_user drop constraint if exists UKsfp0l65piri344cgr5yiugcd3\nHibernate: alter table if exists my_user add constraint UKsfp0l65piri344cgr5yiugcd3 unique (username)\nHibernate: alter table if exists user_roles add constraint FK9oewexa178ua52tkqsfuouoml foreign key (user_id) references my_user\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u65b9\u6cd5\u9274\u6743"}),"\n",(0,t.jsx)(n.p,{children:"\u914d\u7f6e\u7c7b\u52a0\u4e0a\u6ce8\u89e3 @EnableMethodSecurity \uff0c\u5728\u9700\u8981\u9274\u6743\u65b9\u6cd5\u4e0a\u52a0\u4e0a @PreAuthorize \u6ce8\u89e3"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@RequestMapping("/user")\n@ResponseBody\n@PreAuthorize("hasAuthority(\'USER\')")\npublic String user() {\n    return "user";\n}\n\n@RequestMapping("/admin")\n@ResponseBody\n@PreAuthorize("hasAuthority(\'ADMIN\')")\npublic String admin() {\n    return "admin";\n}\n'})})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>a});var s=r(6540);const t={},i=s.createContext(t);function o(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);