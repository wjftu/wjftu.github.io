"use strict";(self.webpackChunkwjftu_ds=self.webpackChunkwjftu_ds||[]).push([[4629],{6047:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"springboot/data/liquibase","title":"Liquibase","description":"Liquibase \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u6570\u636e\u5e93\u53d8\u66f4\u7ba1\u7406\u5de5\u5177\uff0c\u5b83\u5e2e\u52a9\u5f00\u53d1\u56e2\u961f\u8ddf\u8e2a\u3001\u7248\u672c\u63a7\u5236\u548c\u90e8\u7f72\u6570\u636e\u5e93 schema \u7684\u53d8\u5316\u3002\u652f\u6301\u591a\u79cd\u6570\u636e\u5e93\uff0c\u8bb0\u5f55\u53d8\u66f4\u5386\u53f2\u3002","source":"@site/note/springboot/data/liquibase.md","sourceDirName":"springboot/data","slug":"/springboot/data/liquibase","permalink":"/note/springboot/data/liquibase","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":11,"frontMatter":{"title":"Liquibase","sidebar_position":11},"sidebar":"tutorialSidebar","previous":{"title":"Redis","permalink":"/note/springboot/data/redis"},"next":{"title":"WEB \u5e94\u7528","permalink":"/note/springboot/web/"}}');var r=a(4848),s=a(8453);const i={title:"Liquibase",sidebar_position:11},l=void 0,o={},c=[{value:"\u5feb\u901f\u4e0a\u624b",id:"\u5feb\u901f\u4e0a\u624b",level:3},{value:"Liquibase gradle plugin",id:"liquibase-gradle-plugin",level:3}];function d(e){const n={a:"a",code:"code",h3:"h3",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"Liquibase \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u6570\u636e\u5e93\u53d8\u66f4\u7ba1\u7406\u5de5\u5177\uff0c\u5b83\u5e2e\u52a9\u5f00\u53d1\u56e2\u961f\u8ddf\u8e2a\u3001\u7248\u672c\u63a7\u5236\u548c\u90e8\u7f72\u6570\u636e\u5e93 schema \u7684\u53d8\u5316\u3002\u652f\u6301\u591a\u79cd\u6570\u636e\u5e93\uff0c\u8bb0\u5f55\u53d8\u66f4\u5386\u53f2\u3002"}),"\n",(0,r.jsx)(n.h3,{id:"\u5feb\u901f\u4e0a\u624b",children:"\u5feb\u901f\u4e0a\u624b"}),"\n",(0,r.jsx)(n.p,{children:"\u521b\u5efa\u4e00\u4e2a Spring Boot \u9879\u76ee\uff0c\u6570\u636e\u6e90\u7528 h2 database \uff0c\u5f15\u5165 liquibase \u4f9d\u8d56"}),"\n",(0,r.jsx)(n.p,{children:"build.gradle"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-groovy",children:"plugins {\n    id 'java'\n    id 'org.springframework.boot' version '3.3.10'\n    id 'io.spring.dependency-management' version '1.1.7'\n}\n\ndependencies {\n    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'\n    implementation 'org.springframework.boot:spring-boot-starter-web'\n    runtimeOnly 'com.h2database:h2'\n    implementation 'org.liquibase:liquibase-core'\n    testImplementation 'org.springframework.boot:spring-boot-starter-test'\n}\n\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u914d\u7f6e liquibase \u548c h2"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yml",children:"spring:\n  datasource:\n    url: jdbc:h2:mem:testdb\n    driver-class-name: org.h2.Driver\n    username: sa\n    password: ''\n  jpa:\n    hibernate:\n      ddl-auto: validate\n  liquibase:\n    change-log: classpath:db/changelog/changelog-master.xml\n  h2:\n    console:\n      enabled: true\n      path: /h2-console\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u521b\u5efa\u4e00\u4e2a db/changelog/changelog-master.xml \u6587\u4ef6\uff0c\u5f15\u5165\u4e00\u4e2a changelog"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n<databaseChangeLog\n        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"\n        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog\n      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">\n\n    <include file="db/changelog/changes/001-create-person-table.xml"/>\n\n</databaseChangeLog>\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"change log \u7684\u5185\u5bb9\u662f\u521b\u5efa\u4e00\u4e2a\u8868"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:'<?xml version="1.0" encoding="UTF-8"?>\n<databaseChangeLog\n        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"\n        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog\n      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">\n\n    <changeSet id="1" author="yourname">\n        <createTable tableName="person">\n            <column name="id" type="BIGINT" autoIncrement="true">\n                <constraints primaryKey="true" nullable="false"/>\n            </column>\n            <column name="name" type="VARCHAR(255)"/>\n            <column name="age" type="INT"/>\n        </createTable>\n    </changeSet>\n\n</databaseChangeLog>\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u6210\u529f\u521b\u5efa\u4e00\u4e2a table"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"SHOW COLUMNS FROM PERSON;\nFIELD  \tTYPE  \tNULL  \tKEY  \tDEFAULT  \nID\tBIGINT\tNO\tPRI\tNULL\nNAME\tCHARACTER VARYING(255)\tYES\t\tNULL\nAGE\tINTEGER\tYES\t\tNULL\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 changelog file \uff0c 002-add-email-column.xml \uff0c\u7ed9\u8868\u6dfb\u52a0\u4e00\u5217\uff0c\u5e76\u628a\u5b83\u52a0\u5165 changelog-master.xml"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:'<changeSet id="2" author="yourname">\n    <addColumn tableName="person">\n        <column name="email" type="VARCHAR(255)"/>\n    </addColumn>\n</changeSet>\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u65b0\u7684\u8868\u7ed3\u6784"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"FIELD  \tTYPE  \tNULL  \tKEY  \tDEFAULT  \nID\tBIGINT\tNO\tPRI\tNULL\nNAME\tCHARACTER VARYING(255)\tYES\t\tNULL\nAGE\tINTEGER\tYES\t\tNULL\nEMAIL\tCHARACTER VARYING(255)\tYES\t\tNULL\n"})}),"\n",(0,r.jsx)(n.p,{children:"liquibase \u652f\u6301\u591a\u79cd change type"}),"\n",(0,r.jsx)(n.p,{children:"\u4f8b\u5982\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:'\x3c!-- 1. Create a table --\x3e\n<changeSet id="1" author="jeff">\n    <createTable tableName="users">\n        <column name="id" type="BIGINT">\n            <constraints primaryKey="true" nullable="false"/>\n        </column>\n        <column name="username" type="VARCHAR(50)">\n            <constraints unique="true" nullable="false"/>\n        </column>\n        <column name="email" type="VARCHAR(100)"/>\n        <column name="phone" type="VARCHAR(100)"/>\n    </createTable>\n</changeSet>\n\n\x3c!-- 2. Add column --\x3e\n<changeSet id="2" author="jeff">\n    <addColumn tableName="users">\n        <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>\n    </addColumn>\n</changeSet>\n\n\x3c!-- 3. Insert data --\x3e\n<changeSet id="3" author="jeff">\n    <insert tableName="users">\n        <column name="id" valueNumeric="1"/>\n        <column name="username" value="admin"/>\n        <column name="email" value="admin@example.com"/>\n        <column name="phone" value="123"/>\n    </insert>\n    <insert tableName="users">\n        <column name="id" valueNumeric="2"/>\n        <column name="username" value="user"/>\n        <column name="phone" value="234"/>\n    </insert>\n</changeSet>\n\n\x3c!-- 4. Update data --\x3e\n<changeSet id="4" author="jeff">\n    <update tableName="users">\n        <column name="email" value="updated@example.com"/>\n        <where>username = \'admin\'</where>\n    </update>\n</changeSet>\n\n\x3c!-- 5. Delete data --\x3e\n<changeSet id="5" author="jeff">\n    <delete tableName="users">\n        <where>username = \'user\'</where>\n    </delete>\n</changeSet>\n\n\x3c!-- 6. Add NOT NULL constraint --\x3e\n<changeSet id="6" author="jeff">\n    <addNotNullConstraint tableName="users"\n                          columnName="username"\n                          columnDataType="VARCHAR(50)"/>\n</changeSet>\n\n\x3c!-- 7. Drop a column --\x3e\n<changeSet id="7" author="jeff">\n    <dropColumn tableName="users" columnName="email"/>\n</changeSet>\n\n\x3c!-- 8. Rename a column --\x3e\n<changeSet id="8" author="jeff">\n    <renameColumn tableName="users"\n                  oldColumnName="username"\n                  newColumnName="login_name"\n                  columnDataType="VARCHAR(50)"/>\n</changeSet>\n\n\x3c!-- 9. Create index --\x3e\n<changeSet id="9" author="jeff">\n    <createIndex indexName="idx_phone" tableName="users" unique="true">\n        <column name="phone"/>\n    </createIndex>\n</changeSet>\n\n\x3c!-- 10. Drop index --\x3e\n<changeSet id="10" author="you">\n    <dropIndex indexName="idx_phone" tableName="users"/>\n</changeSet>\n\n\x3c!-- 11. Execute raw SQL --\x3e\n<changeSet id="11" author="jeff">\n    <sql>\n        ALTER TABLE users ADD COLUMN status VARCHAR(20) DEFAULT \'active\';\n    </sql>\n</changeSet>\n\n\x3c!-- 12. Modify Column Data Type --\x3e\n<changeSet id="12" author="you">\n    <modifyDataType tableName="users" columnName="phone" newDataType="VARCHAR(10)"/>\n</changeSet>\n'})}),"\n",(0,r.jsx)(n.h3,{id:"liquibase-gradle-plugin",children:"Liquibase gradle plugin"}),"\n",(0,r.jsx)(n.p,{children:"Liquibase gradle plugin \u53ef\u4ee5\u7528 Gradle \u6765\u7ba1\u7406\u6570\u636e\u5e93\u53d8\u66f4"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.a,{href:"https://github.com/Logicify/liquibase-gradle-plugin",children:"https://github.com/Logicify/liquibase-gradle-plugin"})}),"\n",(0,r.jsx)(n.p,{children:"\u5f53\u524d\u6700\u65b0\u7248\u672c 3.0.2 \uff0c\u4f46\u53ef\u80fd\u95ee\u9898\u8f83\u591a\uff0c\u8fd9\u91cc\u4f7f\u7528 2.2.0 \u7248\u672c"}),"\n",(0,r.jsx)(n.p,{children:"\u6dfb\u52a0\u63d2\u4ef6\uff0c\u914d\u7f6e liquibaseRuntime"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"plugins {\n    id 'java'\n    id 'org.springframework.boot' version '3.3.10'\n    id 'io.spring.dependency-management' version '1.1.7'\n    id 'org.liquibase.gradle' version '2.2.0'\n}\n\ndependencies {\n    liquibaseRuntime 'org.liquibase:liquibase-core'  \n    liquibaseRuntime 'org.postgresql:postgresql'            \n    liquibaseRuntime 'info.picocli:picocli:4.6.1'\n}\n\nliquibase {\n    activities {\n        main {\n            changelogFile 'src/main/resources/db/changelog/db.changelog-master.xml'\n            url 'jdbc:postgresql://ip:port/dbname?sslmode=require'\n            username 'username'\n            password 'password'\n            driver 'org.postgresql.Driver'\n        }\n        runList = 'main'\n    }\n}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u7528\u6cd5\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"# \u66f4\u65b0\ngradle update\n\n# \u56de\u6eda 1 \u4e2a changeset\ngradle rollbackCount -PliquibaseCommandValue=1\n\n# \u56de\u6eda\u5230 tag\ngradle rollback -PrunList='dev' -PliquibaseCommandValue=v1.0\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u591a\u73af\u5883\u914d\u7f6e"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"liquibase {\n    activities {\n        main {\n            changelogFile 'src/main/resources/db/changelog/db.changelog-master.xml'\n            url 'jdbc:postgresql://ip:port/dbname?sslmode=require'\n            username 'username'\n            password 'password'\n            driver 'org.postgresql.Driver'\n        }\n        dev {\n            changelogFile 'src/main/resources/db/changelog/db.changelog-master.xml'\n            url 'jdbc:postgresql://ip:port/devdb?sslmode=require'\n            username 'username'\n            password 'password'\n            driver 'org.postgresql.Driver'\n        }\n        runList = project.ext.runList\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u90e8\u7f72\u65f6\u4f20\u5165\u5177\u4f53\u7684\u73af\u5883"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"gradle update -PrunList='dev'\n"})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>i,x:()=>l});var t=a(6540);const r={},s=t.createContext(r);function i(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);